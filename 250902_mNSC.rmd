---
title: "mNSC Bulk RNA-Seq Analysis"
subtitle: "A Modular and Reproducible Pipeline"
author: "Ryan Miller"
date: '`r format(Sys.time(), "Last modified: %d %b %Y")`'
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: show
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Project 250902_mNSC

This R Markdown document serves as the central hub for a modular DESeq2 RNA-seq analysis pipeline. The workflow is designed to be highly reproducible and easily adaptable to new projects by centralizing all configuration parameters.

---

# 1. Setup

This section loads necessary libraries, defines project-specific parameters, and validates the inputs.

## 1.1 Scripts
```{r child-script-setup, file='scripts/00_setup.R', echo=TRUE}
```
```{r format-scripts}
RUN_STYLER <- TRUE
if (RUN_STYLER) {
  styler::style_file(list.files(here::here("scripts"), pattern = "\\.R$", full.names = TRUE))
}
```
```{r child-script-genes, file='scripts/01_genes_mouse.R', echo=TRUE}
```
```{r child-script-qc, file='scripts/02_QC.R', echo=TRUE}
```
```{r child-script-deseq, file='scripts/03_DESeq2.R', echo=TRUE}
```

## 1.2 Project
```{r configuration}
RUN_ANALYSIS <- TRUE
cfg <- list(
  date = format(Sys.Date(), "%y%m%d"),
  project_name = "250902_mNSC",
  dir_input = here::here("input"),
  dir_output = here::here("output"),
  dir_sf = here::here("sf"),
  dir_genesets = here::here("genesets"),
  dir_graphs_png = here::here("graphs", "png"),
  dir_graphs_pdf = here::here("graphs", "pdf"),
  dir_graphs_png_kinase_boxplots = here::here("graphs", "png", "kinase_boxplots"),
  dir_graphs_pdf_kinase_boxplots = here::here("graphs", "pdf", "kinase_boxplots"),
  dir_results_csv = here::here("output", "results_csv"),
  file_samples = here::here("input", "samples.csv"),
  file_gtf = here::here("input", "gencode.vM37.primary_assembly.annotation.gtf.gz"),
  file_kinases = here::here("genesets", "201006_composite_kinases.csv"),
  filter_gene_types = "protein_coding",
  exclude_patterns = c("RIKEN", "cDNA sequence", "predicted gene"),
  exclude_chromosomes = c("MT", "X", "Y"),
  qval_threshold = 0.05,
  lfc_threshold = 1.0,
  filter_min_count = 10,
  batch_vars = c("SeqBatch"),
  main_vars = c("Driver", "Host", "Model"),
  interaction_vars = c("Model", "Driver"),
  filter_by_factor = "Driver",
  qc_plot_settings = list(project_genes = c("Egfr", "Pdgfra", "Pten", "Cdkn2a")),
  analysis_definitions = list(
    subsets = list(Full_Dataset = list(), NS1_Model = list(Model = "NS1"), BL6_Host = list(Host = "BL6")),
    model_types = c("additive", "interaction")
  )
)
cfg$analysis_plan <- list()
for (s_name in names(cfg$analysis_definitions$subsets)) {
  for (m_type in cfg$analysis_definitions$model_types) {
    analysis_name <- paste(s_name, m_type, sep = "_")
    cfg$analysis_plan[[analysis_name]] <- list(model_type = m_type, subset_criteria = cfg$analysis_definitions$subsets[[s_name]])
  }
}
rm(analysis_name, m_type, s_name)
```

## 1.3 Validate Inputs
```{r validate-inputs}
samples <- read.csv(cfg$file_samples, row.names = 1, header = TRUE)
validate_config_and_inputs(cfg, samples)
```

## 1.4 Gene Sets
```{r genesets}
if (file.exists(cfg$file_kinases)) {
  kinase_list <- read.csv(cfg$file_kinases)
  kinase_genes <- unique(kinase_list$Mouse_symbol)
} else {
  kinase_genes <- NULL
}
```

---

# 2. Computational Analysis
```{r computational-analysis, include=FALSE, eval=RUN_ANALYSIS}
set.seed(42)
lapply(
  c(cfg$dir_output, cfg$dir_graphs_png, cfg$dir_graphs_pdf, cfg$dir_results_csv, 
    cfg$dir_graphs_png_kinase_boxplots, cfg$dir_graphs_pdf_kinase_boxplots),
  dir.create, recursive = TRUE, showWarnings = FALSE
)

potential_factors <- names(which(sapply(samples, function(col) {
  n_unique <- length(unique(col))
  n_unique > 1 && n_unique < nrow(samples) && (!is.numeric(col) || n_unique < 15)
})))
samples[, potential_factors] <- lapply(samples[, potential_factors], factor)

files_sf <- file.path(cfg$dir_sf, paste0(rownames(samples), ".sf"))
names(files_sf) <- rownames(samples)
if (!all(file.exists(files_sf))) {
  stop("One or more Salmon files are missing in the 'sf' directory.")
}

gtf_maps <- create_tx2gene_maps(
  gtf_path = cfg$file_gtf, 
  cache_dir = cfg$dir_input,
  filter_gene_types = cfg$filter_gene_types, 
  exclude_patterns = cfg$exclude_patterns,
  exclude_chromosomes = cfg$exclude_chromosomes
)

all_dds_objects <- list()
all_results_lists <- list()

for (analysis_name in names(cfg$analysis_plan)) {
  message(paste("\n--- Starting Analysis:", analysis_name, "---"))
  plan <- cfg$analysis_plan[[analysis_name]]
  
  message("...Subsetting data.")
  current_samples <- samples
  if (length(plan$subset_criteria) > 0) {
    for (col in names(plan$subset_criteria)) {
      current_samples <- current_samples[current_samples[[col]] %in% plan$subset_criteria[[col]], ]
    }
  }
  current_samples <- droplevels(current_samples)
  current_files_sf <- files_sf[rownames(current_samples)]
  
  message("...Building design formula.")
  relevant_vars <- names(which(sapply(current_samples, function(col) length(unique(col)) > 1)))
  batch_terms <- intersect(cfg$batch_vars, relevant_vars)
  main_terms <- intersect(cfg$main_vars, relevant_vars)
  design_str <- paste("~", paste(c(batch_terms, main_terms), collapse = " + "))
  
  if (plan$model_type == "interaction" && all(cfg$interaction_vars %in% main_terms)) {
    other_main_terms <- setdiff(main_terms, cfg$interaction_vars)
    interaction_term <- paste(cfg$interaction_vars, collapse = " * ")
    design_str <- paste("~", paste(c(batch_terms, other_main_terms, interaction_term), collapse = " + "))
  } else if (plan$model_type == "interaction") {
      message("...Interaction not possible, running additive model instead.")
  }
  
  design_formula <- as.formula(design_str)
  message(paste("...Using design:", design_str))
  
  dds_processed <- run_deseq_core(
    samples_df = current_samples, files_sf_vec = current_files_sf, design_formula = design_formula,
    tx2gene_map = gtf_maps$tx2gene_pcg, filter_by_factor = cfg$filter_by_factor,
    filter_min_count = cfg$filter_min_count
  )
  all_dds_objects[[analysis_name]] <- dds_processed
  
  message("...Generating QC plots.")
  generate_qc_plots(dds_processed = dds_processed, analysis_name = analysis_name, 
                    gtf_map = gtf_maps$gene_name_map, cfg = cfg)
  
  message("...Extracting differential expression results.")
  factors_to_compare <- intersect(cfg$main_vars, relevant_vars)
  comparisons <- list()
  for (f in factors_to_compare) {
    level_pairs <- combn(levels(current_samples[[f]]), 2, simplify = FALSE)
    for (pair in level_pairs) {
      comparisons <- append(comparisons, list(list(factor = f, group1 = pair[1], group2 = pair[2])))
    }
  }
  
  results_list <- extract_comparisons(
    dds_processed = dds_processed, comparisons_list = comparisons,
    analysis_name = analysis_name, gene_map = gtf_maps$gene_name_map,
    cfg = cfg, kinase_genes = kinase_genes
  )
  all_results_lists[[analysis_name]] <- results_list
  message(paste("--- Analysis Complete:", analysis_name, "---"))
}

results_filename <- here::here(cfg$dir_input, paste0(cfg$project_name, "_results.RData"))
save(cfg, samples, gtf_maps, all_dds_objects, all_results_lists, kinase_genes, file = results_filename)
message(paste("...Session saved to:", results_filename))
```

---

# 3. Report Generation
This section loads saved results and generates the final report.
```{r load-results, include=FALSE}
if (!exists("all_results_lists")) {
  results_file_path <- here::here(cfg$dir_input, paste0(cfg$project_name, "_results.RData"))
  if (file.exists(results_file_path)) {
    message(paste("Loading latest results from:", results_file_path))
    load(results_file_path, envir = .GlobalEnv)
  } else {
    stop("No results file found. Please set RUN_ANALYSIS to TRUE and knit.")
  }
}
```

## 3.1 Sample Metadata
```{r sample-metadata-table}
reactable::reactable(samples, searchable = TRUE, filterable = TRUE, 
                     bordered = TRUE, highlight = TRUE, defaultPageSize = 10)
```

## 3.2 Quality Control
The plots below provide a QC overview for each analysis performed.

```{r dynamic-qc-plots, results='asis'}
for (analysis_name in names(all_dds_objects)) {
  
  title_name <- gsub("_", " ", analysis_name)
  dds_object <- all_dds_objects[[analysis_name]]
  design_formula <- as.character(design(dds_object))
  
  cat(paste("\n### QC for", title_name, "\n"))
  cat(paste0("\n*Design Formula: `", design_formula, "`*\n"))
  
  cat("\n#### PCA Plot\n")
  pca_plot_path <- here::here(cfg$dir_graphs_png, 
                              paste0(cfg$date, "_", analysis_name, "_PCA.png"))
  if(file.exists(pca_plot_path)) cat(paste0("![](", pca_plot_path, ")")) else cat("\n*PCA plot not found.*\n")

  cat("\n#### Sample Distance Heatmap\n")
  heatmap_plot_path <- here::here(cfg$dir_graphs_png, 
                                  paste0(cfg$date, "_", analysis_name, "_Heatmap.png"))
  if(file.exists(heatmap_plot_path)) cat(paste0("![](", heatmap_plot_path, ")")) else cat("\n*Heatmap not found.*\n")
  
  cat("\n") 
}
```

## 3.3 Gene of Interest Expression
This section displays normalized counts for pre-defined genes of interest across all analysis contexts.

```{r goi-plots, results='asis'}
for (analysis_name in names(all_dds_objects)) {
  
  title_name <- gsub("_", " ", analysis_name)
  cat(paste("\n### GOI Expression for", title_name, "\n"))
  
  plot_files_exist <- any(sapply(cfg$qc_plot_settings$project_genes, function(gene_name) {
    file.exists(here::here(cfg$dir_graphs_png, 
                           paste0(cfg$date, "_", analysis_name, "_GenePlot_", gene_name, ".png")))
  }))

  if (!plot_files_exist) {
    cat("\n*No plots found for configured genes of interest in this analysis subset.*\n")
    next
  }

  for (gene_name in cfg$qc_plot_settings$project_genes) {
    gene_plot_path <- here::here(cfg$dir_graphs_png, 
                                 paste0(cfg$date, "_", analysis_name, "_GenePlot_", gene_name, ".png"))
    
    if(file.exists(gene_plot_path)){
      cat(paste0("\n![](", gene_plot_path, ")"))
    }
  }
  cat("\n")
}
```

## 3.4 Differential Expression Summary
This table provides a high-level overview of the number of differentially expressed genes (DEGs) for each comparison.

```{r results-summary-table}
summary_stats <- list()
for (analysis_name in names(all_results_lists)) {
  analysis_results <- all_results_lists[[analysis_name]]
  if (is.null(analysis_results) || length(analysis_results) == 0) next
  
  for (comp_name in names(analysis_results)) {
    res_df <- analysis_results[[comp_name]]
    sig_df <- res_df %>% dplyr::filter(padj < cfg$qval_threshold & abs(log2FoldChange) > cfg$lfc_threshold)
    
    summary_stats[[comp_name]] <- list(
      `Total Genes Tested` = nrow(res_df),
      `Significant DEGs` = nrow(sig_df),
      `Up-regulated` = sig_df %>% dplyr::filter(log2FoldChange > 0) %>% nrow(),
      `Down-regulated` = sig_df %>% dplyr::filter(log2FoldChange < 0) %>% nrow()
    )
  }
}
summary_df <- dplyr::bind_rows(summary_stats, .id = "Comparison")
reactable::reactable(summary_df, searchable = TRUE, bordered = TRUE, highlight = TRUE,
                     columns = list(Comparison = colDef(minWidth = 400)))
```

## 3.5 Detailed Comparison Results
This section provides a detailed table and plots for each comparison.

```{r dynamic-results-report, results='asis'}
for (analysis_name in names(all_results_lists)) {
  title_name <- gsub("_", " ", analysis_name)
  cat(paste("\n### DEG Results for", title_name, "\n"))
  
  analysis_results <- all_results_lists[[analysis_name]]
  if (length(analysis_results) == 0) next
  
  for (comp_name in names(analysis_results)) {
    cat(paste("\n####", gsub("_", " ", comp_name), "\n"))
    comp_df <- analysis_results[[comp_name]]
    sig_genes <- comp_df %>% dplyr::filter(padj < cfg$qval_threshold)
    if (nrow(sig_genes) > 0) {
      print(reactable::reactable(sig_genes %>% arrange(padj), defaultPageSize = 5, searchable = TRUE,
                                 bordered = TRUE, highlight = TRUE))
    } else {
       cat("\n*No significant genes found for this comparison.*\n")
    }
    
    cat("\n\n##### Volcano Plot\n")
    volcano_plot_path <- here::here(cfg$dir_graphs_png, paste0(cfg$date, "_", comp_name, "_volcano.png"))
    if(file.exists(volcano_plot_path)) cat(paste0("![](", volcano_plot_path, ")"))
    
    cat("\n\n##### Top 50 DEG Heatmap\n")
    deg_heatmap_path <- here::here(cfg$dir_graphs_png, paste0(cfg$date, "_", comp_name, "_DEG_heatmap.png"))
    if(file.exists(deg_heatmap_path)) cat(paste0("![](", deg_heatmap_path, ")")) else cat("\n*Heatmap not generated.*\n")
    
    cat("\n\n##### Top Kinase DEG Heatmap\n")
    kinase_heatmap_path <- here::here(cfg$dir_graphs_png, paste0(cfg$date, "_", comp_name, "_Kinase_DEG_heatmap.png"))
    if(file.exists(kinase_heatmap_path)) cat(paste0("![](", kinase_heatmap_path, ")")) else cat("\n*Kinase heatmap not generated.*\n")

    cat("\n\n##### Differentially Expressed Kinase Box Plots\n")
    sig_kinases <- sig_genes %>% dplyr::filter(gene_name %in% kinase_genes)
    if(nrow(sig_kinases) > 0) {
      for(kinase_name in sig_kinases$gene_name) {
        plot_path <- here::here(cfg$dir_graphs_png, "kinase_boxplots", paste0(cfg$date, "_", comp_name, "_Boxplot_", kinase_name, ".png"))
        if(file.exists(plot_path)) cat(paste0("![](", plot_path, ")"))
      }
    } else {
      cat("\n*No differentially expressed kinases found for this comparison.*\n")
    }
    cat("\n")
  }
}
```

---

# 4. Session
```{r session-info}
sessionInfo()
```