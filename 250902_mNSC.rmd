---
title: "Tomo mouse NSC bulk RNAseq profiling"
subtitle: "DESeq2 (Modular & Reproducible Analysis)"
author: "Ryan Miller"
date: '`r format(Sys.time(), "Last modified: %d %b %Y")`'
output:
  html_document:
    toc: yes
    code_folding: show
    theme: journal
---

This document runs a full differential expression analysis pipeline within a containerized environment.  It assumes all packages are pre-installed, as in a Docker container. All paths are relative to the /data project root.
<hr>

# R Setup and Global Variables

### 1. Define Directories and Parameters
Global parameters and paths for the entire analysis are defined here. Child scripts are now functions that will receive these paths as arguments.

```{r, message=FALSE, warning=FALSE}
# --- Define Relative Paths for the Project ---
dir_scripts <- "./scripts"
dir_input   <- "./input"
dir_output  <- "./output"
dir_graphs  <- "./graphs" # Centralized directory for all plots

# --- Create Output Directories if They Don't Exist ---
dir.create(dir_output, recursive = TRUE, showWarnings = FALSE)
dir.create(dir_graphs, recursive = TRUE, showWarnings = FALSE)

# --- File Paths ---
file_gtf <- file.path(dir_input, "gencode.vM37.primary_assembly.annotation.gft.gz")
file_samples <- file.path(dir_input, "samples.csv")
file_kinases <- file.path(dir_input, "genesets/201006_composite_kinases.csv")
dir_sf <- "./sf" # Base directory for Salmon quantification files

# --- DESeq2 Parameters ---
pval <- 0.05
qval <- 0.05
lfc  <- 1.0 # Log2 fold-change cutoff
filt <- 20  # Low read count filter cutoff

# --- Other Variables ---
date <- format(Sys.Date(), format = "%y%m%d")
nc <- BiocParallel::multicoreWorkers()
set.seed(888)

# --- Genes of Interest ---
project_genes <- c("Egfr", "Pdgfra", "Pten", "Cdkn2a")

# Colors
blp <- colorRampPalette(rev(brewer.pal(9, "Blues")))(255)
ryb <- colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(100)
```

### 2. Library Loading
Source the setup script to load packages.
```{r, echo=TRUE, message=TRUE, include=TRUE}
# Source the setup script to load all required packages
source(file.path(dir_scripts, "00_setup.R"), local = knitr::knit_global())
```

### 3. Sample metadata 
```{r}
# Load from the project root directory
samples <- read.csv(file_samples, row.names = 1, header = TRUE)

# --- Auto-detect and convert potential experimental factors ---
message("\n--- Auto-detecting potential experimental factors from sample metadata ---")

# Identify columns suitable for use as factors in statistical modeling.
# A column is considered a potential factor if:
#   1. It has more than one unique value (i.e., it's not constant).
#   2. It has fewer unique values than the number of samples (i.e., it's not a unique ID).
#   3. If it's a numeric column, it must have a low number of unique values (e.g., < 15)
#      to be considered categorical (like 'SeqBatch') rather than continuous.
# Auto-detect and convert potential experimental factors.
potential_factors <- names(which(sapply(samples, function(col) {
  num_unique <- length(unique(col))
  is_categorical <- num_unique > 1 && num_unique < nrow(samples)
  if (is.numeric(col) && num_unique >= 15) { is_categorical <- FALSE }
  return(is_categorical)
})))

samples[, potential_factors] <- lapply(samples[, potential_factors], factor)

# --- REINSERTED: SF File Path Logic ---
# The logic to create the full path to each 'quant.sf' file is centralized here.
# It uses the 'dir_sf' variable defined in the setup chunk and the sample names
# from the metadata's row names.
message("--- Generating paths to quantification files ---")
files_sf <- file.path(dir_sf, paste0(rownames(samples), ".sf"))
names(files_sf) <- rownames(samples)

# Verification step to ensure all files exist before proceeding
if (!all(file.exists(files_sf))) {
  stop("One or more Salmon quantification files are missing. Check the 'dir_sf' path.")
}
message(paste("Successfully located", length(files_sf), "quantification files."))
# --- END SF File Logic ---

reactable::reactable(samples)
```

### 3. Generate File Paths to Count Data
```{r}
# --- Dynamically Create File Paths ---
message("\\n--- Generating paths to sf quant files ---")

# Define the base directory where the Salmon output folders are located.
# This path should be relative to your project root.
quant_base_dir <- "./sf" 

# Get the sample names from your metadata file (assuming they are row names).
sample_names <- rownames(samples)

# Construct the full path to each 'quant.sf' file.
# This assumes a structure like: ./sf/TK001.sf
files_sf_vec <- file.path(quant_base_dir, sample_names, ".sf")

# It's good practice to name the elements of the vector with the sample names.
names(files_sf_vec) <- sample_names

# --- Verification Step ---
# Check that all the generated file paths actually exist before proceeding.
if (!all(file.exists(files_sf_vec))) {
  stop("One or more quantification files could not be found. Please check the 'quant_base_dir' path and your directory structure.")
}

message(paste("Successfully located", length(files_sf_vec), "quantification files."))
print(head(files_sf_vec))
```


### 5. DESeq2 Model Design - Full dataset
Define the statistical models that will be used for the analysis.
```{r}
# Variables for the DESeq2 model designs
vars_model <- c("SeqBatch", "Host", "Model", "Driver")
vars_int <- c("Model*Driver")
sb <- "SeqBatch"

# Create a named list of design formulas
designs <- list(model_1 = as.formula(paste("~", paste(vars_model, collapse = " + "))),
                model_2 = as.formula(paste("~", sb, "+", 
                                           paste(vars_int, collapse = " + ")
)))
print("Models to be used in the main analysis")
print(designs)
```

### 6. Define data subsets
```{r}
# --- Subset 1: Model == 'NS1' ---
message("--- Defining subset for Model == 'NS1' ---")
samples_ns1 <- samples[samples$Model == "NS1", ]
samples_ns1 <- droplevels(samples_ns1)
files_sf_ns1 <- files_sf[rownames(samples_ns1)]
message(paste("Subset 'samples_ns1' contains", nrow(samples_ns1), "samples."))

# --- Subset 2: Host == 'BL6' ---
message("\n--- Defining subset for Host == 'BL6' ---")
samples_bl6 <- samples[samples$Host == "BL6", ]
samples_bl6 <- droplevels(samples_bl6)
files_sf_bl6 <- files_sf[rownames(samples_bl6)]
message(paste("Subset 'samples_bl6' contains", nrow(samples_bl6), "samples."))
```

### 7. Genesets
```{r}
#### Kinases
file_kinases <- "./genesets/201006_composite_kinases.csv"
if (file.exists(file_kinases)) {
  kinases <- read.csv(file_kinases, header = TRUE, fileEncoding = "UTF-8-BOM")
} else {
  stop(paste("File not found:", file_kinases))
}
kinase_genes <- kinases$Mouse_symbol
```

### 8. Graph Annotations and Colors
```{r echo=TRUE, message=FALSE}
anno_vars <- c("Host", "Model", "Driver")
anno <- as.data.frame(samples[, anno_vars])
summarized_anno <- anno %>%
  group_by(across(all_of(anno_vars))) %>%
  summarize(n = n(), .groups = "drop")
# Display as an interactive table
reactable(
  summarized_anno,
  searchable = TRUE,
  filterable = TRUE,
  resizable = TRUE
)

# Get unique entries for each variable
unique_values_by_var <- lapply(anno, unique)
unique_values_by_var

anno_colors <- list(
  Driver = c(
    "EGFRvIII" = "blue",
    "EGFRvV" = "dodgerblue",
    "PDGFRA" = "red"
  ),
  Model = c(
    "NS1" = "green",
    "NS2" = "blue",
    "GBO" = "black",
    "Tumor" = "purple"
  ),
  Host = c("NSG" = "gray", "BL6" = "black")
)
```

### 9. DESeq2 - Full dataset
```{r}
# Defining DESeq2 Model Designs for full dataset
vars_model <- c("SeqBatch", "Host", "Model", "Driver")
vars_int <- c("Model*Driver")
designs <- list(
  model_1 = as.formula(paste("~", paste(vars_model, collapse = " + "))),
  model_2 = as.formula(paste("~", "SeqBatch", "+", paste(vars_int, collapse = " + ")))
)

# Source the runner script
source("./scripts/04_DESeq_runner.R",
       local = knitr::knit_global(),
       echo = TRUE)
```

### 10. DESeq2 Comparisons - Subset == 'NS1' Models
```{r}
# --- Programmatically define all pairwise comparisons for the subset ---
message("\n--- Generating all pairwise comparisons for the NS1 subset ---")
# For this subset, the relevant factors that vary are Driver and Host
factors_to_compare_ns1 <- c("Driver", "Host")
all_comparisons_ns1 <- list()

for (f in factors_to_compare_ns1) {
  # Get factor levels from the subsetted dataframe
  factor_levels <- levels(samples_ns1[[f]])
  level_pairs <- combn(factor_levels, 2, simplify = FALSE)
  
  for (pair in level_pairs) {
    comp <- list(factor = f,
                 group1 = pair[1],
                 group2 = pair[2])
    all_comparisons_ns1 <- append(all_comparisons_ns1, list(comp))
  }
}
message(paste(
  "...Generated",
  length(all_comparisons_ns1),
  "pairwise comparisons."
))

# --- Set Parameters for this run ---
analysis_params <- list(
  samples_df = samples_ns1,
  files_sf_vec = files_sf_ns1,
  design_formula = as.formula("~ SeqBatch + Host + Driver"),
  analysis_name = "NS1_Model_Subset",
  comparisons_list = all_comparisons_ns1
)

# Source the runner script
source("./scripts/04_DESeq_runner.R",
       local = knitr::knit_global(),
       echo = TRUE)
```

### 11. DESeq2 Comparisons - Subset == 'BL6' Host
```{r}
# --- Programmatically define all pairwise comparisons for the subset ---
message("\n--- Generating all pairwise comparisons for the BL6 subset ---")
# For this subset, the relevant factors that vary are Model and Driver
factors_to_compare_bl6 <- c("Model", "Driver")
all_comparisons_bl6 <- list()

for (f in factors_to_compare_bl6) {
  # Get factor levels from the subsetted dataframe
  factor_levels <- levels(samples_bl6[[f]])
  level_pairs <- combn(factor_levels, 2, simplify = FALSE)
  
  for (pair in level_pairs) {
    comp <- list(factor = f,
                 group1 = pair[1],
                 group2 = pair[2])
    all_comparisons_bl6 <- append(all_comparisons_bl6, list(comp))
  }
}
message(paste(
  "...Generated",
  length(all_comparisons_bl6),
  "pairwise comparisons."
))

# --- Set Parameters for this run ---
analysis_params <- list(
  samples_df = samples_bl6,
  files_sf_vec = files_sf_bl6,
  design_formula = as.formula("~ SeqBatch + Model + Driver"),
  analysis_name = "BL6_Host_Subset",
  comparisons_list = all_comparisons_bl6
)

# Source the generic runner script
source("./scripts/04_DESeq_runner.R",
       local = knitr::knit_global(),
       echo = TRUE)
```
<hr>

# Analysis Pipeline
This section sources the external R scripts that perform the analysis. Each script is run in the global environment to ensure it can access and modify shared data objects. local = knitr::knit_global() is critical for ensuring they all run in the same environment and can share variables.

### 1. Mouse Genes
```{r echo=TRUE, message=TRUE, include = TRUE}
source("./scripts/01_genes_mouse.R", local = knitr::knit_global(), echo = TRUE)
```

### 2. Data Prep
```{r echo=TRUE, message=TRUE, include = TRUE}
source("./scripts/02_data_prep.R", local = knitr::knit_global(), echo = TRUE)
```

### 3. Quality Control
```{r echo=TRUE, message=TRUE, include = TRUE}
source("./scripts/03_QC.R", local = knitr::knit_global(), echo = TRUE)
```

### 4. Differential Expression Analysis (Full dataset)
```{r echo=TRUE, message=TRUE, include = TRUE}
# --- Programmatically define all pairwise comparisons for key factors ---
message("\n--- Generating all pairwise comparisons for Driver, Model, and Host factors ---")

# List of factors to generate comparisons for
factors_to_compare <- c("Driver", "Model", "Host")
all_comparisons <- list()

for (f in factors_to_compare) {
  # Get the unique levels for the factor from the main samples table
  factor_levels <- levels(samples[[f]])
  
  # Generate all unique 2-item combinations (pairs) of the levels
  level_pairs <- combn(factor_levels, 2, simplify = FALSE)
  
  # Create the list structure required by the 04_DESeq_runner.R script
  for (pair in level_pairs) {
    comp <- list(factor = f,
                 group1 = pair[1],
                 group2 = pair[2])
    all_comparisons <- append(all_comparisons, list(comp))
  }
}

message(paste(
  "...Generated",
  length(all_comparisons),
  "pairwise comparisons to be executed."
))

# --- Set Parameters for this run ---
analysis_params <- list(
  samples_df = samples,
  files_sf_vec = files_sf,
  design_formula = designs$model_1,
  # Using the main effects model
  analysis_name = "Full_Dataset_Main_Effects",
  # Use the new, complete list of comparisons
  comparisons_list = all_comparisons
)

# Source the runner script to execute the analysis for all comparisons
source("./scripts/04_DESeq_runner.R",
       local = knitr::knit_global(),
       echo = TRUE)
```

### 5. Differential Expression Analysis (Model == 'NS1' Subset)
```{r}
# --- Set Parameters for this run ---
analysis_params <- list(
  samples_df = samples_ns1,
  files_sf_vec = files_sf_ns1,
  design_formula = as.formula("~ SeqBatch + Host + Driver"),
  analysis_name = "NS1_Model_Subset",
  comparisons_list = list(
    list(factor = "Driver", group1 = "EGFRvV", group2 = "EGFRvIII"),
    list(factor = "Driver", group1 = "PDGFRA", group2 = "EGFRvIII"),
    list(factor = "Driver", group1 = "PDGFRA", group2 = "EGFRvV")
  )
)

# Source the runner script
source("./scripts/04_DESeq_runner.R", local = knitr::knit_global(), echo = TRUE)
```

### 6. Differential Expression Analysis (Host == 'BL6' Subset)
```{r}
# --- Set Parameters for this run ---
analysis_params <- list(
  samples_df = samples_bl6,
  files_sf_vec = files_sf_bl6,
  design_formula = as.formula("~ SeqBatch + Model + Driver"),
  analysis_name = "BL6_Host_Subset",
  # Define all pairwise comparisons for both factors
  comparisons_list = list(
    list(factor = "Model", group1 = "Tumor", group2 = "GBO"),
    list(factor = "Model", group1 = "NS1", group2 = "NS2"),
    list(factor = "Driver", group1 = "PDGFRA", group2 = "EGFRvIII"),
    list(factor = "Driver", group1 = "PDGFRA", group2 = "EGFRvV")
  )
)

# Source the generic runner script
source("./scripts/04_DESeq_runner.R", local = knitr::knit_global(), echo = TRUE)
```

# Session Info
```{r}
sessionInfo()
```