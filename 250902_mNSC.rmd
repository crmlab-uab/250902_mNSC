---
title: "mNSC Bulk RNA-Seq Analysis"
subtitle: "A Modular and Reproducible Pipeline"
author: "Ryan Miller"
date: '`r format(Sys.time(), "Last modified: %d %b %Y")`'
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: show
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Project 250902_mNSC

This R Markdown document serves as the central hub for a modular DESeq2 RNA-seq analysis pipeline. The workflow is designed to be highly reproducible and easily adaptable to new projects by centralizing all configuration parameters.

Please ensure your project follows this directory structure. Opening the .Rproj file within the appropriate <project_folder> is the key step that makes all the relative paths work correctly.

/project_folder/
|
|-- project_folder.Rproj      <-- ALWAYS double-click this file to open the project
|-- project_folder.rmd              <-- The main script to "knit"
|
|-- scripts/                     
|   |-- 00_setup.R
|   |-- 01_genes_mouse.R
|   |-- 02_QC.R
|   |-- 03_DESeq_runner.R
|
|-- input/
|   |-- samples.csv         <-- The first column of this file should be sample names                                          correpsonding to sf files below (e.g. sample_name_001.sf)
|   |-- gencode.vM37.primary_assembly.annotation.gft.gz
                            <-- This analysis is designed for mouse.
|
|-- sf/
|   |-- sample_name_001.sf
|   |-- ... (and so on)

**Key Features:**

* **Modular Functions:** Core tasks like package loading, gene annotation, quality control, and DESeq2 analysis are handled by external, version-controlled `.R` scripts.
* **Centralized Configuration:** All project-specific paths, parameters, and analysis definitions are set in a single `cfg` list in the chunk below.
* **Dynamic Analysis Plan:** The pipeline programmatically generates analysis plans based on defined subsets and model types, eliminating redundant code.
* **Reproducibility:** The `RUN_ANALYSIS` switch separates time-consuming computation from rapid report generation. Results are cached, and package versions can be managed with `renv`.

---

# 1. Setup and Configuration

This section loads necessary libraries and functions and defines all project-specific parameters. **This is the only section you need to edit for a new project.**

```{r configuration}
# =============================================================================
# CHUNK 1: CONFIGURATION SETUP
# =============================================================================

# --- Master Switch ---
# Set to TRUE to run the full, time-consuming analysis.
# Set to FALSE to load the latest saved results and quickly generate the report.
RUN_ANALYSIS <- TRUE

# --- Load Libraries and Child Scripts ---
# These scripts must be in a subfolder named 'scripts'.
source(here::here("scripts", "00_setup.R"))
source(here::here("scripts", "01_genes_mouse.R"))
source(here::here("scripts", "02_QC.R"))
source(here::here("scripts", "03_DESeq2.R"))

# --- Project-Specific Configuration (cfg) ---
cfg <- list(
  # A. General Settings
  date = format(Sys.Date(), "%y%m%d"),
  project_name = "250902_mNSC",
  
  # B. File Paths (relative to the project root)
  file_samples = here::here("input", "samples.csv"),
  file_gtf = here::here("input", "gencode.vM37.primary_assembly.annotation.gtf.gz"),
  dir_sf = here::here("sf"),
  dir_output = here::here("output"),
  dir_graphs = here::here("graphs"),
  dir_results_csv = here::here("output", "results_csv"),
  
  # C. Gene Annotation Settings
  filter_gene_types = "protein_coding",
  exclude_patterns = c("RIKEN", "cDNA sequence", "predicted gene"),
  exclude_chromosomes = c("MT", "X", "Y"),
  
  # D. DESeq2 Settings
  qval_threshold = 0.05,
  lfc_threshold = 1.0,
  filter_min_count = 10,
  # Parameterized filter count
  
  # E. Experimental Design Definition
  batch_vars = c("SeqBatch"),
  main_vars = c("Host", "Model", "Driver"),
  interaction_vars = c("Model", "Driver"),
  filter_by_factor = "Driver",
  
  # F. QC Plot Settings
  qc_plot_settings = list(
    project_genes = c("Egfr", "Pdgfra", "Pten", "Cdkn2a"),
    annotation_colors = list(
      Driver = c(
        "EGFRvIII" = "blue",
        "EGFRvV" = "dodgerblue",
        "PDGFRA" = "red"
      ),
      Model = c(
        "NS1" = "#7FC97F",
        "NS2" = "#BEAED4",
        "GBO" = "#FDC086",
        "Tumor" = "#386CB0"
      ),
      Host = c("NSG" = "grey50", "BL6" = "black")
    )
  ),
  
  # G. Analysis Plan Definition (DYNAMIC)
  # Define the building blocks for the analysis here. The script will
  # programmatically generate all combinations.
  analysis_definitions = list(
    # Define a named list of data subsets to analyze. An empty list means 'all data'.
    subsets = list(
      Full_Dataset = list(),
      NS1_Model = list(Model = "NS1"),
      BL6_Host = list(Host = "BL6")
    ),
    # Define the model types to run on each subset.
    model_types = c("additive", "interaction")
  )
)

# --- Programmatically Generate the Full Analysis Plan ---
# This loop creates the final `cfg$analysis_plan` based on the definitions above.
cfg$analysis_plan <- list()
for (s_name in names(cfg$analysis_definitions$subsets)) {
  for (m_type in cfg$analysis_definitions$model_types) {
    analysis_name <- paste(s_name, m_type, sep = "_")
    cfg$analysis_plan[[analysis_name]] <- list(
      model_type = m_type,
      subset_criteria = cfg$analysis_definitions$subsets[[s_name]]
    )
  }
}
rm(analysis_name, m_type, s_name) # Clean up temp variables
```

---

# 2. Computational Analysis

This section executes the full analysis when `RUN_ANALYSIS` is `TRUE`. It processes the data according to the `analysis_plan` and saves all results to disk.

```{r computational-analysis, include=FALSE, eval=RUN_ANALYSIS}
# =============================================================================
# CHUNK 2: DATA PROCESSING AND ANALYSIS
# =============================================================================

set.seed(42) # Set seed for reproducibility

# Create all output directories.
lapply(
  c(cfg$dir_output, cfg$dir_graphs, cfg$dir_results_csv),
  dir.create,
  recursive = TRUE,
  showWarnings = FALSE
)

# Load and process sample metadata.
message("--- Loading and preparing data ---")
samples <- read.csv(cfg$file_samples, row.names = 1, header = TRUE)
potential_factors <- names(which(sapply(samples, function(col) {
  n_unique <- length(unique(col))
  n_unique > 1 &&
    n_unique < nrow(samples) && (!is.numeric(col) || n_unique < 15)
})))
samples[, potential_factors] <- lapply(samples[, potential_factors], factor)

files_sf <- file.path(cfg$dir_sf, paste0(rownames(samples), ".sf"))
names(files_sf) <- rownames(samples)
if (!all(file.exists(files_sf))) {
  stop("One or more Salmon files are missing in the 'sf' directory.")
}

gtf_maps <- create_tx2gene_maps(
  gtf_path = cfg$file_gtf,
  cache_dir = cfg$dir_output,
  current_date = cfg$date,
  filter_gene_types = cfg$filter_gene_types,
  exclude_patterns = cfg$exclude_patterns,
  exclude_chromosomes = cfg$exclude_chromosomes
)

all_dds_objects <- list()
all_results_lists <- list()

# --- Dynamic Analysis Loop ---
for (analysis_name in names(cfg$analysis_plan)) {
  message(paste("\n--- Starting Analysis:", analysis_name, "---"))
  plan <- cfg$analysis_plan[[analysis_name]]
  
  # 1. Subset data based on criteria.
  current_samples <- samples
  if (length(plan$subset_criteria) > 0) {
    for (col in names(plan$subset_criteria)) {
      current_samples <- current_samples[current_samples[[col]] %in% plan$subset_criteria[[col]], ]
    }
  }
  current_samples <- droplevels(current_samples)
  current_files_sf <- files_sf[rownames(current_samples)]
  
  # 2. Programmatically build the DESeq2 design formula.
  relevant_vars <- names(which(sapply(current_samples, function(col) length(unique(col)) > 1)))
  batch_terms <- intersect(cfg$batch_vars, relevant_vars)
  main_terms <- intersect(cfg$main_vars, relevant_vars)
  design_str <- paste("~", paste(c(batch_terms, main_terms), collapse = " + "))
  
  if (plan$model_type == "interaction" && all(cfg$interaction_vars %in% main_terms)) {
    other_main_terms <- setdiff(main_terms, cfg$interaction_vars)
    interaction_term <- paste(cfg$interaction_vars, collapse = " * ")
    design_str <- paste("~", paste(c(batch_terms, other_main_terms, interaction_term), collapse = " + "))
  } else if (plan$model_type == "interaction") {
      message("...Interaction not possible for this subset, running additive model instead.")
  }
  
  design_formula <- as.formula(design_str)
  message(paste("...Using design:", design_str))
  
  # 3. Run core DESeq2 analysis.
  dds_processed <- run_deseq_core(
    samples_df = current_samples,
    files_sf_vec = current_files_sf,
    design_formula = design_formula,
    tx2gene_map = gtf_maps$tx2gene_pcg,
    filter_by_factor = cfg$filter_by_factor,
    filter_min_count = cfg$filter_min_count
  )
  all_dds_objects[[analysis_name]] <- dds_processed
  
  # 4. Generate and Save QC Plots for this analysis.
  generate_qc_plots(
    dds_processed = dds_processed,
    analysis_name = analysis_name,
    gtf_map = gtf_maps$gene_name_map,
    cfg = cfg
  )
  
  # 5. Generate comparisons and extract results.
  factors_to_compare <- intersect(cfg$main_vars, relevant_vars)
  comparisons <- list()
  for (f in factors_to_compare) {
    level_pairs <- combn(levels(current_samples[[f]]), 2, simplify = FALSE)
    for (pair in level_pairs) {
      comparisons <- append(comparisons, list(list(
        factor = f, group1 = pair[1], group2 = pair[2]
      )))
    }
  }
  
  results_list <- extract_comparisons(
    dds_processed = dds_processed,
    comparisons_list = comparisons,
    analysis_name = analysis_name,
    gene_map = gtf_maps$gene_name_map,
    cfg = cfg
  )
  all_results_lists[[analysis_name]] <- results_list
}

# --- Save All Results ---
message("\n--- Saving analysis session to file ---")
results_filename <- here::here(cfg$dir_output,
                               paste0(cfg$date, "_", cfg$project_name, "_results.RData"))
save(cfg, samples, gtf_maps, all_dds_objects, all_results_lists, file = results_filename)
message(paste("...Session saved to:", results_filename))
```

---

# 3. Report Generation

This section loads the saved results (if `RUN_ANALYSIS` is `FALSE`) and generates the final report with tables and figures.

```{r load-results, include=FALSE}
# =============================================================================
# CHUNK 3: LOAD RESULTS
# =============================================================================
if (!exists("all_results_lists")) {
  results_files <- list.files(
    path = cfg$dir_output,
    pattern = "_results.RData$",
    full.names = TRUE
  )
  if (length(results_files) > 0) {
    latest_results_file <- sort(results_files, decreasing = TRUE)[1]
    message(paste("Loading latest results from:", latest_results_file))
    load(latest_results_file)
  } else {
    stop("No results file found. Please set RUN_ANALYSIS to TRUE and knit.")
  }
}
```

## 3.1 Sample Metadata

The following table displays the metadata for all samples included in the project.

```{r sample-metadata-table}
reactable::reactable(
  samples,
  searchable = TRUE,
  filterable = TRUE,
  bordered = TRUE,
  highlight = TRUE,
  defaultPageSize = 10
)
```

## 3.2 Quality Control

The plots below provide a QC overview for the `Full_Dataset_additive` analysis. A complete set of QC plots for *every* analysis defined in the `analysis_plan` has been saved to the `graphs/` directory.

### PCA Plot

Principal Component Analysis (PCA) visualizes the sample-to-sample distances. Samples that are biologically similar should cluster together.

```{r pca-plot, fig.width=10, fig.height=8}
pca_plot_path <- here::here(cfg$dir_graphs,
                            paste0(cfg$date, "_Full_Dataset_additive_PCA.png"))
if (file.exists(pca_plot_path)) {
  knitr::include_graphics(pca_plot_path)
} else {
  "PCA plot not found. Please run the analysis."
}
```

### Sample Distance Heatmap

This heatmap provides another view of sample similarity based on variance-stabilized expression data.

```{r heatmap-plot, fig.width=10, fig.height=8}
heatmap_plot_path <- here::here(cfg$dir_graphs,
                                paste0(cfg$date, "_Full_Dataset_additive_Heatmap.png"))
if (file.exists(heatmap_plot_path)) {
  knitr::include_graphics(heatmap_plot_path)
} else {
  "Heatmap not found. Please run the analysis."
}
```

## 3.3 Differential Expression Results

This section dynamically generates a summary table for each significant comparison made in each analysis.

* Full, sortable results tables for every comparison are saved as `.csv` files in `output/results_csv/`.
* Volcano plots for every comparison are saved as `.png` files in `graphs/`.

```{r dynamic-results-report, results='asis'}
# =============================================================================
# CHUNK 4: DYNAMIC RESULTS REPORTING
# =============================================================================
for (analysis_name in names(all_results_lists)) {
  cat(paste("\n###", gsub("_", " ", analysis_name), "\n"))
  analysis_results <- all_results_lists[[analysis_name]]
  
  if (is.null(analysis_results) || length(analysis_results) == 0) {
    cat("\nNo valid comparisons were performed for this analysis group.\n")
    next
  }
  
  for (comp_name in names(analysis_results)) {
    cat(paste("\n####", gsub("_", " ", comp_name), "\n"))
    comp_df <- analysis_results[[comp_name]]
    
    sig_genes <- comp_df %>%
      dplyr::filter(padj < cfg$qval_threshold)
    
    if (nrow(sig_genes) > 0) {
      results_table <- sig_genes %>%
        arrange(padj) %>%
        reactable::reactable(
          searchable = TRUE, filterable = TRUE, bordered = TRUE, highlight = TRUE,
          defaultPageSize = 5,
          columns = list(
            log2FoldChange = colDef(format = colFormat(digits = 2)),
            # FIX: Use a custom cell function for scientific notation
            padj = colDef(
              name = "Adjusted P-value",
              cell = function(value) {
                formatC(value, format = "e", digits = 2)
              }
            )
          )
        )
      print(results_table)
    } else {
      cat("\n*No significant genes found for this comparison.*\n")
    }
    cat("\n")
  }
}
```

---

# 4. Session
This section provides details about the R environment, operating system, and package versions used to run this analysis, ensuring reproducibility.
```{r session-info}
sessionInfo()
```