---
title: "Tomo mouse NSC bulk RNAseq profiling"
subtitle: "DESeq2 (Modular & Reproducible Analysis)"
author: "Ryan Miller"
date: '`r format(Sys.time(), "Last modified: %d %b %Y")`'
output:
  html_document:
    toc: yes
    code_folding: show
    theme: journal
---

# Project Setup
This document runs a full differential expression analysis pipeline within a containerized environment.  It assumes all packages are pre-installed, as in a Docker container. All paths are relative to the /data project root.

<hr>

# R Setup and Global Variables
### 1. Library Loading
```{r, echo=TRUE, message=TRUE, include=TRUE}
# Source the setup script to load all packages
source("./scripts/00_setup.R", local = knitr::knit_global(), echo = TRUE)
```

### 2. Sample metadata 
```{r}
# Load from the project root directory
samples <- read.csv("./input/samples.csv", row.names = 1, header = TRUE)

# --- Convert all model variables to factors ---
# This ensures DESeq2 treats them as discrete categories, not continuous numbers.
vars <- c("SeqBatch", "Host", "Model", "Driver")
message("...Converting model variables to factors...")
for (v in vars) {
  samples[[v]] <- factor(samples[[v]])
}
message("Displaying sample metadata")
reactable::reactable(samples)

# Generate paths to salmon quantification files
files_sf <- paste0("./sf/", rownames(samples), ".sf")
names(files_sf) <- rownames(samples)
if (!all(file.exists(files_sf))) {
  stop("One or more Salmon quantification files are missing from the ./sf/ directory.")
}
```

### 3. Define Directories and Parameters
Global parameters for the analysis are defined here. Child scripts will inherit these.
```{r}
# Output directories
dir_output <- "./output/"
dir_graph <- "./graphs/"
dir.create(dir_output, showWarnings = FALSE, recursive = TRUE)
dir.create(dir_graph, showWarnings = FALSE, recursive = TRUE)

# Path to genome annotation file
file_gtf <- "./input/gencode.vM37.primary_assembly.annotation.gtf.gz"

# DESeq2 parameters
pval <- 0.05
qval <- 0.05
lfc <- 1
filt <- 20 # Low read count filter cutoff

# Other variables
date <- format(Sys.Date(), format = "%y%m%d")
nc <- BiocParallel::multicoreWorkers()
set.seed(888)

# Genes of Interest
project_genes <- c("Egfr", "Pdgfra", "Pten", "Cdkn2a")

# Colors
blp <- colorRampPalette(rev(brewer.pal(9, "Blues")))(255)
ryb <- colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(100)
```

### 4. DESeq2 Model Design
Define the statistical models that will be used for the analysis.
```{r}
# Variables for the DESeq2 model designs
vars_model <- c("SeqBatch", "Host", "Model", "Driver")
vars_int <- c("Model*Driver")
sb <- "SeqBatch"

# Create a named list of design formulas
designs <- list(model_1 = as.formula(paste("~", paste(vars_model, collapse = " + "))),
                model_2 = as.formula(paste("~", sb, "+", 
                                           paste(vars_int, collapse = " + ")
)))
print("Models to be used in the main analysis")
print(designs)
```

### 5. Genesets
```{r}
#### Kinases
file_kinases <- "./genesets/201006_composite_kinases.csv"
if (file.exists(file_kinases)) {
  kinases <- read.csv(file_kinases, header = TRUE, fileEncoding = "UTF-8-BOM")
} else {
  stop(paste("File not found:", file_kinases))
}
kinase_genes <- kinases$Mouse_symbol
```

### 6. Graph Annotations and Colors
```{r echo=TRUE, message=FALSE}
anno_vars <- c("Host", "Model", "Driver")
anno <- as.data.frame(samples[, anno_vars])
summarized_anno <- anno %>%
  group_by(across(all_of(anno_vars))) %>%
  summarize(n = n(), .groups = "drop")
# Display as an interactive table
reactable(
  summarized_anno,
  searchable = TRUE,
  filterable = TRUE,
  resizable = TRUE
)

# Get unique entries for each variable
unique_values_by_var <- lapply(anno, unique)
unique_values_by_var

anno_colors <- list(
  Driver = c(
    "EGFRvIII" = "blue",
    "EGFRvV" = "dodgerblue",
    "PDGFRA" = "red"
  ),
  Model = c(
    "NS1" = "green",
    "NS2" = "blue",
    "GBO" = "black",
    "Tumor" = "purple"
  ),
  Host = c("NSG" = "gray", "BL6" = "black")
)
```

### 7. Full DESeq2 Model Design
```{r}
# Defining DESeq2 Model Designs for full dataset
vars_model <- c("SeqBatch", "Host", "Model", "Driver")
vars_int <- c("Model*Driver")
designs <- list(
  model_1 = as.formula(paste("~", paste(vars_model, collapse = " + "))),
  model_2 = as.formula(paste("~", "SeqBatch", "+", paste(vars_int, collapse = " + ")))
)
```

### 8. Defined subsets
```{r}
# --- Subset 1: Model == 'NS1' ---
samples_ns1 <- samples[samples$Model == "NS1", ]
samples_ns1 <- droplevels(samples_ns1)
files_sf_ns1 <- files_sf[rownames(samples_ns1)]
message(paste("Subset 'samples_ns1' contains", nrow(samples_ns1), "samples."))

# --- Subset 2: Host == 'BL6' ---
samples_bl6 <- samples[samples$Host == "BL6", ]
samples_bl6 <- droplevels(samples_bl6)
files_sf_bl6 <- files_sf[rownames(samples_bl6)]
message(paste("Subset 'samples_bl6' contains", nrow(samples_bl6), "samples."))
```

<hr>

# Analysis Pipeline
This section sources the external R scripts that perform the analysis. Each script is run in the global environment to ensure it can access and modify shared data objects. local = knitr::knit_global() is critical for ensuring they all run in the same environment and can share variables.

### 1. Mouse Genes
```{r echo=TRUE, message=TRUE, include = TRUE}
source("./scripts/01_genes_mouse.R", local = knitr::knit_global(), echo = TRUE)
```

### 2. Data Prep
```{r echo=TRUE, message=TRUE, include = TRUE}
source("./scripts/02_data_prep.R", local = knitr::knit_global(), echo = TRUE)
```

### 3. Quality Control
```{r echo=TRUE, message=TRUE, include = TRUE}
source("./scripts/03_QC.R", local = knitr::knit_global(), echo = TRUE)
```

### 4. Differential Expression Analysis
```{r echo=TRUE, message=TRUE, include = TRUE}
source("./scripts/04_DESeq.R", local = knitr::knit_global(), echo = TRUE)
```

### 5. Differential Expression Analysis (Model == 'NS1' Subset)
```{r}
# --- Set Parameters for this run ---
analysis_params <- list(
  samples_df = samples_ns1,
  files_sf_vec = files_sf_ns1,
  design_formula = as.formula("~ SeqBatch + Host + Driver"),
  factors_to_compare = c("Driver"),
  subset_name = "NS1_Model"
)

# Source the generic child script
source("./scripts/05_DESeq_subset.R", local = knitr::knit_global(), echo = TRUE)
```

### 6. Differential Expression Analysis (Host == 'BL6' Subset)
```{r}
# --- Set Parameters for this run ---
analysis_params <- list(
  samples_df = samples_bl6,
  files_sf_vec = files_sf_bl6,
  design_formula = as.formula("~ SeqBatch + Model + Driver"),
  factors_to_compare = c("Model", "Driver"),
  subset_name = "BL6_Host"
)

# Source the generic child script
source("./scripts/05_DESeq_subset.R", local = knitr::knit_global(), echo = TRUE)
```

# Session Info
```{r}
sessionInfo()
```